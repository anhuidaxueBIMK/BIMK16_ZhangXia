ResultAUC=zeros(1,20);
Resulttime=zeros(1,20);
raito=3;%噪音添加为0,1,2,3分别表示不添加噪音，添加10%，20%，30%噪音
lambda2=2^-10;%lambda=2^[-10:1;10]
s=100;%缓冲区大小设为100
convex=50;%前面50个样本凸优化防止落入局部最优，不宜设置过大
 load('german.mat');
       Yt=label;%Yt为标签数据
Xt=instance;%Xt为样本特征数据
           [Xt,PS] = mapminmax(Xt);%归一化
 for p=1:4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
  alpha=2^-8;%步长设置2^[-8:1:8]
   uu1=0;%uu1=[0,0.9]
   uu2=0.9999;%uu2=[0.9 0.99 0.999 0.9999]
  [M,N]=size(Xt);
indices=crossvalind('Kfold', Xt(1:M,N), 5);%K折交叉
c=zeros(1,5);
time=zeros(1,5);
  for k=1:5%交叉验证k=5，5个包轮流作为测试集
        test =(indices ==k); %获得test集元素在数据集中对应的单元编号
        train = ~test;%train集元素的编号为非test元素的编号
       Xtr=Xt(train,:);%/从数据集中划分出train样本的数据
Ytr=Yt(train,:);
        Xte=Xt(test,:);%test样本集
Yte=Yt(test,:);
beta=1e-8;
T=length(Ytr);
if raito>=1
index= randperm(T,ceil(raito/10*T));
 index1=find(Ytr(index)==1);
 index2=find(Ytr(index)==-1);
Ytr(index(index1))=-1;
  Ytr(index(index2))=1;
end
Ztr=[Xtr Ytr];
  d=size(Xtr,2);%存放数据维度
  B=[];
 w=zeros(1,d);     
 z=zeros(1,d);   
 q=zeros(1,d); 
 mt=zeros(1,d);
 mt1=zeros(1,d);
 vt1=zeros(1,d);
 vt=zeros(1,d);
 gt=zeros(1,d); 
 outlier=0;
   tic;
for t=1:T
    label=Ztr(t,end);
    instance=Ztr(t,1:end-1);
    loss=zeros(1,d);
     number=0;
if ~isempty(B)
 index=find(B(:,end)~=label);
    m= length(index);
     if m>0
    if t<=convex%前convex样本采用凸损失优化
     for i=1:m
        tmp=label*(instance-B(index(i),1:end-1));%依次与缓冲区样本配对
         score=tmp*w';
        if score<1
            loss=loss-tmp;%计算损失
         end
     end 
     gt=lambda2*w+1/m*loss;
    else%进入ramp损失优化
          for i=1:m
        tmp=label*(instance-B(index(i),1:end-1));%依次与缓冲区样本配对
                 score=tmp*w';
             if score<1 && score>=-1
             loss=loss-tmp;%计算损失
             end
          end
     gt=lambda2*w+1/m*loss;%计算梯度
   end
end
        mt=uu1*mt+(1-uu1)*gt;%一阶矩估计
     vt=uu2*vt+(1-uu2)*gt.^2;%二阶矩估计
     mt1=mt/(1-uu1^t);
     vt1=vt/(1-uu2^t);
      w=w-alpha*mt1./(sqrt(vt1)+beta);%自适应更新分类器
end
  B=BufferFIFO(B,Ztr(t,:),t,s);%缓冲区更新
end
toc;
time(k)=toc;
AUC=ComputeAUC(Xte,Yte,w);
c(k)=AUC;
c(isnan(c)) = 0;
  end                       
  ResultAUC(1,(p-1)*5+1:p*5)=c;
Resulttime(1,(p-1)*5+1:p*5)=time;     
   end        
 fprintf('AUC %.4f\n',mean( ResultAUC))
   fprintf('标准差 %.4f\n',std(ResultAUC))
   fprintf('用时 %.4f\n',mean(Resulttime))
 
